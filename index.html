<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Valentine’s Side Quest</title>
<style>
  body {
    margin: 0;
    background: #0b0f14;
    color: #c9d1d9;
    font-family: monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }

  #container {
    width: 900px;
    max-width: 95vw;
    text-align: center;
  }

  canvas {
    background: #0e1621;
    border: 2px solid #1f6feb;
    display: none;
    margin: 0 auto;
  }

  .hidden {
    display: none;
  }

  button {
    background: #1f6feb;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
  }

  button:hover {
    background: #388bfd;
  }

  #dialogue {
    min-height: 140px;
    white-space: pre-wrap;
  }
</style>
</head>
<body>

<div id="container">
  <div id="dialogue"></div>
  <button id="actionBtn" class="hidden">Begin Side Quest</button>
  <canvas id="game" width="900" height="300"></canvas>
</div>

<script>
/* =======================
   TYPEWRITER
======================= */
const dialogueBox = document.getElementById("dialogue");
const actionBtn = document.getElementById("actionBtn");

function typeText(text, callback) {
  dialogueBox.innerHTML = "";
  let i = 0;
  const interval = setInterval(() => {
    dialogueBox.innerHTML += text[i];
    i++;
    if (i >= text.length) {
      clearInterval(interval);
      if (callback) callback();
    }
  }, 30);
}

/* =======================
   GAME SETUP
======================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let keys = {};
let level = 1;
let gameRunning = false;

const gravity = 0.6;
const groundHeight = 260;

/* =======================
   PLAYER (PIXEL PUPPY)
======================= */
const player = {
  x: 100,
  y: 0,
  vx: 0,
  vy: 0,
  width: 18,
  height: 14,
  onGround: false
};

/* =======================
   CAMERA
======================= */
let cameraX = 0;

/* =======================
   LEVEL DATA
======================= */
const levels = {
  1: {
    length: 2400,
    platforms: [],
    gaps: [],
    bones: Array.from({length:5},(_,i)=>({x:400+i*300,y:220,collected:false}))
  },
  2: {
    length: 2800,
    platforms: [
      {x:600,y:200,w:80},
      {x:820,y:170,w:80},
      {x:1100,y:190,w:80},
      {x:1500,y:160,w:100}
    ],
    gaps: [],
    bones: Array.from({length:6},(_,i)=>({x:500+i*350,y:150,collected:false}))
  },
  3: {
    length: 3000,
    platforms: [
      {x:700,y:180,w:90},
      {x:1000,y:150,w:90},
      {x:1400,y:190,w:90},
      {x:1800,y:140,w:120}
    ],
    gaps: [
      {x:900,w:120},
      {x:1300,w:160},
      {x:1700,w:180}
    ],
    heart: {x:2600,y:200,size:40}
  }
};

/* =======================
   INPUT
======================= */
window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

/* =======================
   DRAW PUPPY
======================= */
function drawPuppy(px, py) {
  ctx.fillStyle = "#3fb950";
  ctx.fillRect(px, py, player.width, player.height);
  ctx.fillRect(px+14, py-4, 6, 6); // ear
  ctx.fillRect(px-4, py+4, 4, 4); // tail
}

/* =======================
   GAME LOOP
======================= */
function update() {
  if (!gameRunning) return;

  // movement
  if (keys["ArrowRight"]) player.vx = 3;
  else if (keys["ArrowLeft"]) player.vx = -3;
  else player.vx *= 0.8;

  if (keys[" "] && player.onGround) {
    player.vy = -10;
    player.onGround = false;
  }

  player.vy += gravity;
  player.x += player.vx;
  player.y += player.vy;

  // ground
  player.onGround = false;
  if (player.y + player.height >= groundHeight) {
    player.y = groundHeight - player.height;
    player.vy = 0;
    player.onGround = true;
  }

  // platforms
  levels[level].platforms?.forEach(p => {
    if (
      player.x + player.width > p.x &&
      player.x < p.x + p.w &&
      player.y + player.height > p.y &&
      player.y + player.height < p.y + 10 &&
      player.vy >= 0
    ) {
      player.y = p.y - player.height;
      player.vy = 0;
      player.onGround = true;
    }
  });

  // gaps (level 3)
  levels[level].gaps?.forEach(g => {
    if (player.x > g.x && player.x < g.x + g.w && player.y > canvas.height) {
      player.x = 100;
      player.y = 0;
      cameraX = 0;
    }
  });

  cameraX = player.x - canvas.width / 2;

  draw();
  requestAnimationFrame(update);
}

/* =======================
   DRAW WORLD
======================= */
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(-cameraX,0);

  // ground
  ctx.fillStyle = "#30363d";
  ctx.fillRect(0, groundHeight, levels[level].length, 40);

  // platforms
  ctx.fillStyle = "#6e7681";
  levels[level].platforms?.forEach(p=>{
    ctx.fillRect(p.x,p.y,p.w,10);
  });

  // bones
  levels[level].bones?.forEach(b=>{
    if (!b.collected) {
      ctx.fillStyle = "#f0f6fc";
      ctx.fillRect(b.x,b.y,10,6);
      if (
        player.x < b.x+10 &&
        player.x+player.width > b.x &&
        player.y < b.y+6 &&
        player.y+player.height > b.y
      ) {
        b.collected = true;
        if (levels[level].bones.every(x=>x.collected)) finishLevel();
      }
    }
  });

  // heart (level 3)
  if (level === 3) {
    const h = levels[3].heart;
    ctx.fillStyle = "#ff4d6d";
    ctx.fillRect(h.x,h.y,h.size,h.size);
    if (
      player.x < h.x+h.size &&
      player.x+player.width > h.x &&
      player.y < h.y+h.size &&
      player.y+player.height > h.y
    ) {
      endGame();
    }
  }

  drawPuppy(player.x,player.y);
  ctx.restore();
}

/* =======================
   LEVEL TRANSITIONS
======================= */
function finishLevel() {
  gameRunning = false;
  canvas.style.display = "none";

  if (level === 1) {
    typeText("BOSS FIGHT UNLOCKED.\nStrength isn’t loud. It’s disciplined.\n\nProceed?", ()=>{
      actionBtn.textContent = "Next Level";
      actionBtn.classList.remove("hidden");
      actionBtn.onclick = ()=>startLevel(2);
    });
  } else if (level === 2) {
    typeText("SYSTEM BREACH.\nYou adapt. You persist.\n\nContinue deeper?", ()=>{
      actionBtn.textContent = "Final Level";
      actionBtn.classList.remove("hidden");
      actionBtn.onclick = ()=>startLevel(3);
    });
  }
}

function startLevel(n) {
  level = n;
  player.x = 100;
  player.y = 0;
  cameraX = 0;
  actionBtn.classList.add("hidden");
  dialogueBox.innerHTML = "";
  canvas.style.display = "block";
  gameRunning = true;
  update();
}

function endGame() {
  gameRunning = false;
  canvas.style.display = "none";
  typeText(
    "ENDGAME.\n\nThat moment — quiet, safe, present.\nWhere the world fell away.\n\nYou don’t make me feel strange.\nYou make me feel here.\n\nWell done, Mr. Cody.",
    ()=>{}
  );
}

/* =======================
   INTRO
======================= */
typeText("SYSTEM ONLINE.\n\nPress Y to begin.", ()=>{
  window.addEventListener("keydown", e=>{
    if (e.key.toLowerCase()==="y") {
      actionBtn.classList.remove("hidden");
    }
  });
});

actionBtn.onclick = ()=>{
  actionBtn.classList.add("hidden");
  dialogueBox.innerHTML = "";
  canvas.style.display = "block";
  gameRunning = true;
  update();
};
</script>

</body>
</html>
