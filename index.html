<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Valentine’s Side Quest</title>
<style>
  body {
    margin: 0;
    background: black;
    color: #ff9ecb;
    font-family: monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  #container {
    width: 900px;
    max-width: 95vw;
    text-align: center;
  }
  canvas {
    display: none;
    background: #0b0b0b;
    border: 2px solid #ff9ecb;
    margin: 0 auto;
  }
  button {
    background: black;
    color: #ff9ecb;
    border: 2px solid #ff9ecb;
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
  }
  button:hover {
    background: #ff9ecb;
    color: black;
  }
  #dialogue {
    min-height: 140px;
    white-space: pre-wrap;
  }
  .hidden { display: none; }
</style>
</head>
<body>

<!-- AUDIO -->
<audio id="bgMusic" src="8-punk.mp3" loop></audio>
<audio id="clickSound" src="click.wav"></audio>

<div id="container">
  <div id="dialogue"></div>
  <button id="actionBtn" class="hidden">Begin Side Quest</button>
  <canvas id="game" width="900" height="300"></canvas>
</div>

<script>
/* ===== AUDIO ===== */
const bgMusic = document.getElementById("bgMusic");
const clickSound = document.getElementById("clickSound");

function playClick() {
  clickSound.currentTime = 0;
  clickSound.play();
}
function startMusic() {
  if(bgMusic.paused) bgMusic.play();
}

/* ===== TYPEWRITER ===== */
const dialogueBox = document.getElementById("dialogue");
const actionBtn = document.getElementById("actionBtn");
function typeText(text, callback){
  dialogueBox.innerHTML="";
  let i=0;
  const interval=setInterval(()=>{
    dialogueBox.innerHTML+=text[i];
    i++;
    if(i>=text.length){
      clearInterval(interval);
      if(callback) callback();
    }
  },30);
}

/* ===== GAME SETUP ===== */
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let keys={};
let path=0;
let gameRunning=false;
const tileSize=24;
const cols=30, rows=12;

/* ===== PLAYER (PIXEL PUPPY) ===== */
const player={x:1,y:1,barkTimer:0};

/* ===== MAZES (3 PATHS) ===== */
const mazes = [
  [
    "##############################",
    "#     #       #        #     #",
    "#  B  #   B   #   B    #  B  #",
    "#     #       #        #     #",
    "#     ######## ########       #",
    "#                              #",
    "#   B          #      B       #",
    "#      ######      ######     #",
    "#                              #",
    "# B       B          B        #",
    "##############################"
  ],
  [
    "##############################",
    "#  B       ##   B       ##    #",
    "#     ####     ####       B   #",
    "# B      B            B       #",
    "#######      ######     #######",
    "#                              #",
    "#     B       #      B         #",
    "#   ######      #######        #",
    "#          B           B       #",
    "# B        ##    B             #",
    "##############################"
  ],
  [
    "##############################",
    "#  B     B       #       B    #",
    "#       ####      ####        #",
    "#   B         B       B       #",
    "#######      ######     #######",
    "#                              #",
    "#   B      #          B        #",
    "#       ######     ####        #",
    "#  B           B               #",
    "#       ##        B            #",
    "##############################"
  ]
];

/* ===== COLLECTIBLES & GAME ===== */
let collectibles=[];
function setupCollectibles(){
  collectibles=[];
  const maze = mazes[path-1];
  for(let y=0;y<maze.length;y++){
    for(let x=0;x<maze[y].length;x++){
      if(maze[y][x]==="B"){
        collectibles.push({x,y,collected:false});
      }
    }
  }
}

/* ===== INPUT ===== */
window.addEventListener("keydown", e=>keys[e.key]=true);
window.addEventListener("keyup", e=>keys[e.key]=false);

/* ===== PUPPY DRAW ===== */
function drawPuppy(px,py){
  ctx.save();
  const screenX=px*tileSize;
  const screenY=py*tileSize;
  // Body
  ctx.fillStyle="#a0522d";
  ctx.fillRect(screenX,screenY+6,tileSize-6,tileSize-6);
  // Head
  ctx.fillRect(screenX+12,screenY,12,12);
  // Ears
  ctx.fillRect(screenX+11,screenY-4,4,4);
  ctx.fillRect(screenX+19,screenY-4,4,4);
  // Tail
  let tailOffset=Math.sin(Date.now()/100)*3;
  ctx.fillRect(screenX-6,screenY+10+tailOffset,6,3);
  // Eyes
  ctx.fillStyle="black";
  ctx.fillRect(screenX+14,screenY+2,2,2);
  ctx.fillRect(screenX+18,screenY+2,2,2);
  // Snout/Nose
  ctx.fillRect(screenX+17,screenY+8,4,3);
  // Tongue pops
  if(keys["ArrowUp"] || keys["ArrowDown"] || keys["ArrowLeft"] || keys["ArrowRight"]){
    ctx.fillStyle="#ff69b4";
    ctx.fillRect(screenX+17,screenY+11,4,2);
  }
  // Bark
  if(player.barkTimer>0){
    ctx.fillStyle="#ff69b4";
    ctx.font="12px monospace";
    ctx.fillText("woof! ♥",screenX,screenY-6);
    player.barkTimer--;
  }
  ctx.restore();
}

/* ===== GAME LOOP ===== */
function update(){
  if(!gameRunning) return;

  let dx=0,dy=0;
  if(keys["ArrowUp"]) dy=-1;
  else if(keys["ArrowDown"]) dy=1;
  if(keys["ArrowLeft"]) dx=-1;
  else if(keys["ArrowRight"]) dx=1;

  const newX = player.x + dx;
  const newY = player.y + dy;

  const maze = mazes[path-1];
  if(maze[newY] && maze[newY][newX]!=="#"){
    player.x=newX;
    player.y=newY;
  }

  // check collectibles
  collectibles.forEach(c=>{
    if(!c.collected && c.x===player.x && c.y===player.y){
      c.collected=true;
      player.barkTimer=20;
    }
  });

  // check if finished
  if(collectibles.every(c=>c.collected)){
    gameRunning=false;
    canvas.style.display="none";
    showDialogue();
  }

  draw();
  requestAnimationFrame(update);
}

/* ===== DRAW MAZE ===== */
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const maze = mazes[path-1];
  for(let y=0;y<maze.length;y++){
    for(let x=0;x<maze[y].length;x++){
      const screenX=x*tileSize;
      const screenY=y*tileSize;
      if(maze[y][x]==="#"){
        ctx.fillStyle="#ff9ecb";
        ctx.fillRect(screenX,screenY,tileSize,tileSize);
      } else if(maze[y][x]==="B" && !collectibles.find(c=>c.x===x&&c.y===y).collected){
        ctx.fillStyle="#ffc0cb";
        ctx.fillRect(screenX+8,screenY+8,8,8);
      }
    }
  }
  drawPuppy(player.x,player.y);
}

/* ===== DIALOGUE AFTER MAZE ===== */
function showDialogue(){
  const dialogues=[
    "BOSS FIGHT UNLOCKED.\nStrength isn’t loud. It’s disciplined.\n\nProceed?",
    "SYSTEM BREACH.\nYou adapt. You persist.\n\nContinue deeper?",
    "ENDGAME.\n\nThat moment — quiet, safe, present.\nWhere the world fell away.\n\nYou don’t make me feel strange.\nYou make me feel here.\n\nWell done, Mr. Cody."
  ];
  typeText(dialogues[path-1],()=>{
    actionBtn.textContent= path<3 ? "Next Path" : "Return to Menu";
    actionBtn.classList.remove("hidden");
    actionBtn.onclick = () => {
      playClick();
      if(path<3){
        startMaze(path+1);
      } else {
        dialogueBox.innerHTML="SYSTEM OFFLINE.";
        actionBtn.classList.add("hidden");
      }
    };
  });
}

/* ===== START MAZE ===== */
function startMaze(n){
  path=n;
  player.x=1; player.y=1;
  setupCollectibles();
  actionBtn.classList.add("hidden");
  dialogueBox.innerHTML="";
  canvas.style.display="block";
  gameRunning=true;
  update();
}

/* ===== INTRO ===== */
typeText("SYSTEM ONLINE.\n\nPress Y to begin.",()=>{
  window.addEventListener("keydown",e=>{
    if(e.key.toLowerCase()==="y"){
      playClick();
      startMusic();
      actionBtn.classList.remove("hidden");
    }
  });
});

actionBtn.onclick = ()=>{
  playClick();
  startMusic();
  startMaze(1);
};
</script>
</body>
</html>
